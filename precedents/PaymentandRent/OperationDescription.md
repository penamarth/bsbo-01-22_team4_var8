# Описание Системных Операций

## 1. Операция: `confirmTerms(rentalID: RentalID, terms: Terms)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды

**Предусловия:**
- Квартиросъёмщик и владелец аутентифицированы в системе.
- Квартиросъёмщик выбрал и забронировал жильё для аренды.
- Квартиросъёмщик ознакомился с условиями аренды.

**Постусловия:**
- Подтверждены условия аренды.
- Условия аренды сохранены в системе.
- Связь между объектом аренды и условиями установлена.

**Действия:**
1. Система получает вызов метода `confirmTerms(rentalID, terms)`.
2. Создается экземпляр класса `RentalAgreement`, если он еще не существует.
3. Экземпляру `RentalAgreement` присваиваются переданные условия `terms`.
4. Связывается `RentalAgreement` с текущим объектом аренды по `rentalID`.
5. Состояние аренды обновляется на "условия подтверждены".

---

## 2. Операция: `calculateTotal(rentalID: RentalID)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды

**Предусловия:**
- Условия аренды подтверждены.
- Все дополнительные сборы и комиссии определены.

**Постусловия:**
- Итоговая сумма аренды вычислена и сохранена.
- Сумма включает стоимость аренды, залог и комиссии.

**Действия:**
1. Система вызывает метод `Payment::calculateTotal(rentalID)`.
2. Извлекаются данные о стоимости аренды из `RentalAgreement`.
3. Добавляются дополнительные сборы, такие как залог и комиссии.
4. Итоговая сумма сохраняется в системе как `totalAmount`.
5. `totalAmount` связывается с текущим объектом платежа.

---

## 3. Операция: `redirectToPayment(paymentID: PaymentID)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды

**Предусловия:**
- Итоговая сумма аренды вычислена.
- Пользователь инициировал процесс оплаты.

**Постусловия:**
- Квартиросъёмщик перенаправлен на страницу оплаты.
- Платёжная сессия инициирована.

**Действия:**
1. Система вызывает метод `Payment::redirect(paymentID)`.
2. Генерируется URL для платёжной системы с параметрами `paymentID` и `totalAmount`.
3. Квартиросъёмщик перенаправляется на страницу оплаты платёжной системы.

---

## 4. Операция: `processPayment(paymentDetails: PaymentDetails)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды

**Предусловия:**
- Квартиросъёмщик находится на странице оплаты.
- Платёжные данные введены и отправлены.

**Постусловия:**
- Платёж обработан.
- Статус платежа обновлен в системе.

**Действия:**
1. Платёжная система получает `paymentDetails` от квартиросъёмщика.
2. Платёжные данные проверяются на валидность.
3. Происходит авторизация и списание средств.
4. Результат транзакции (успешно/неуспешно) возвращается в систему.
5. Статус платежа обновляется в системе согласно результату транзакции.

---

## 5. Операция: `completePayment(paymentID: PaymentID)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды

**Предусловия:**
- Платёж успешно обработан.
- Статус платежа подтверждён.

**Постусловия:**
- Платёж подтверждён и зафиксирован в системе.
- Связь между платежом и договором аренды установлена.

**Действия:**
1. Система вызывает метод `Payment::complete(paymentID)`.
2. Статус платежа обновляется на "завершён".
3. Информация о платеже сохраняется в базе данных.
4. Связь между `Payment` и `RentalAgreement` устанавливается по `paymentID`.

---

## 6. Операция: `generateAgreement(rentalID: RentalID)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды

**Предусловия:**
- Платёж успешно завершён.
- Все условия аренды подтверждены.

**Постусловия:**
- Электронный договор аренды сгенерирован.
- Договор готов к регистрации.

**Действия:**
1. Система вызывает метод `RentalAgreement::generate(rentalID)`.
2. На основе подтверждённых условий создаётся документ договора аренды.
3. Договор сохраняется в формате PDF или другом юридически значимом формате.
4. Связь между договором и объектом аренды устанавливается.

---

## 7. Операция: `registerAgreement(agreementID: AgreementID)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды

**Предусловия:**
- Электронный договор аренды сгенерирован.
- Договор готов к юридической регистрации.

**Постусловия:**
- Договор аренды зарегистрирован в системе юридической регистрации.
- Договор получает юридическую силу.

**Действия:**
1. Система вызывает метод `LegalRegistry::register(agreementID)`.
2. Договор передаётся в систему юридической регистрации через API.
3. Система юридической регистрации подтверждает регистрацию договора.
4. Статус договора обновляется на "зарегистрирован".
5. Лог регистрации сохраняется для аудита.

---

## 8. Операция: `notifyUsers(userIDs: List<UserID>, message: String)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды

**Предусловия:**
- Договор аренды успешно заключён и зарегистрирован.
- Стороны готовы получать уведомления.

**Постусловия:**
- Квартиросъёмщик и владелец получили уведомления о заключении договора и подтверждении оплаты.

**Действия:**
1. Система вызывает метод `NotificationService::notifyUsers(userIDs, message)`.
2. Для каждого `userID` из списка отправляется сообщение `message` через выбранный канал (электронная почта, SMS, внутренняя система уведомлений).
3. Статус отправки уведомлений фиксируется в системе.
4. В случае ошибки отправки уведомления система регистрирует инцидент для последующей обработки.

---

## 9. Операция: `handlePaymentFailure(paymentID: PaymentID, reason: String)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды (альтернативный поток: Платеж не прошёл успешно)

**Предусловия:**
- Платёж не был успешно обработан.

**Постусловия:**
- Квартиросъёмщик уведомлён о неудачной попытке оплаты.
- Состояние аренды остаётся неизменным или обновляется согласно логике системы.

**Действия:**
1. Система получает уведомление об ошибке платежа через метод `Payment::fail(paymentID, reason)`.
2. Статус платежа обновляется на "неудачный".
3. Квартиросъёмщик получает уведомление о неудачной попытке оплаты с предложением попробовать другой способ оплаты.
4. Система регистрирует ошибку для анализа и возможного исправления.

---

## 10. Операция: `createInstallmentPlan(paymentID: PaymentID, installments: List<Installment>)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды (альтернативный поток: Рассрочка или частичная оплата)

**Предусловия:**
- Квартиросъёмщик выбрал опцию рассрочки.
- Сумма аренды подлежит разделению на платежи.

**Постусловия:**
- План рассрочки создан и сохранён в системе.
- Квартиросъёмщик уведомлён о деталях рассрочки.

**Действия:**
1. Квартиросъёмщик выбирает опцию рассрочки на странице оплаты.
2. Система вызывает метод `Payment::createInstallmentPlan(paymentID, installments)`.
3. План рассрочки разбивается на несколько платежей с указанием сроков и сумм.
4. План рассрочки сохраняется в системе и связывается с `paymentID`.
5. Квартиросъёмщик получает уведомление о созданном плане рассрочки.

---

## 11. Операция: `updateTerms(rentalID: RentalID, newTerms: Terms)`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды (альтернативный поток: Запрос на изменение условий аренды)

**Предусловия:**
- Квартиросъёмщик запросил изменение условий аренды.
- Владелец согласен на изменения.

**Постусловия:**
- Условия аренды обновлены в системе.
- Обновлённый договор аренды сохранён и готов к регистрации.

**Действия:**
1. Квартиросъёмщик инициирует запрос на изменение условий аренды.
2. После согласования, система вызывает метод `RentalAgreement::updateTerms(rentalID, newTerms)`.
3. Условия аренды обновляются в экземпляре `RentalAgreement`.
4. Обновлённый договор аренды генерируется заново.
5. Обновлённый договор передаётся на юридическую регистрацию через `LegalRegistry::register(agreementID)`.

---

## 12. Операция: `handleSystemFailure()`

**Ссылки:**  
Прецеденты: Оплата и заключение договора аренды (расширение: При выходе системы из строя)

**Предусловия:**
- Система выходит из строя во время процесса оплаты или заключения договора.

**Постусловия:**
- Все транзакции и события восстановлены.
- Состояние системы возвращено к предыдущему стабильному состоянию.
- Кассир уведомлён о сбое и необходимости перезапуска.

**Действия:**
1. Система обнаруживает сбой и переходит в режим восстановления.
2. Кассир перезапускает систему и регистрируется.
3. Система предлагает восстановить предыдущее состояние транзакции.
4. При успешном восстановлении:
    - Состояние транзакции возвращается к моменту сбоя.
    - Пользователь уведомляется о возможности продолжить процесс.
5. При обнаружении аномалии:
    - Система уведомляет кассира о технической проблеме.
    - Ошибка регистрируется в логах.
    - Система переходит в начальное состояние.
    - Кассир инициирует новую операцию оплаты.