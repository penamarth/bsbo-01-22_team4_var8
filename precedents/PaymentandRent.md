 Описание прецедента: "Оплата и заключение договора аренды"

---

**Информационная система жилищного агентства.**

Уровень. Задача, определенная пользователем.

Основной исполнитель: Квартиросъёмщик.

**Заинтересованные лица и их требования:**

- **Квартиросъёмщик (пользователь).** Хочет безопасно и удобно оплатить аренду выбранного жилья, получив подтверждение об успешной оплате и договор аренды.
- **Владелец (пользователь).** Хочет получить уведомление о заключении договора и подтверждение успешной оплаты арендной платы.
- **Система юридической регистрации.** Хочет зафиксировать заключение договора аренды и гарантировать его юридическую силу.
- **Администратор системы.** Хочет убедиться, что все платежи и заключение договоров происходят корректно и в соответствии с законодательством.
- **Компания (владелец платформы).** Хочет получать комиссионные за успешные сделки и поддерживать безопасность и стабильность работы системы.

**Предусловия:**

- Квартиросъёмщик и владелец зарегистрированы и аутентифицированы в системе.
- Квартиросъёмщик выбрал жильё и забронировал его для аренды.
- Обе стороны ознакомились с условиями аренды и готовы заключить договор.

**Результаты (Постусловия):**

- Квартиросъёмщик успешно оплатил аренду и получил электронный договор аренды.
- Владелец получил уведомление о заключении договора аренды и подтверждение получения средств.
- Платеж успешно обработан и зафиксирован в системе.
- Система обновила данные о текущих арендах и сгенерировала юридически значимый договор аренды.

**Основной успешный сценарий:**

1. **Подтверждение условий аренды:**
   - Квартиросъёмщик переходит на страницу подтверждения аренды и нажимает "Подтвердить и оплатить".
   - Система вызывает метод `RentalAgreement::confirmTerms()` для сохранения условий аренды (сроки, стоимость и т.д.).

2. **Перенаправление на систему платежей:**
   - Система вычисляет итоговую сумму аренды, включая все дополнительные сборы (залог, комиссия), вызывая метод `Payment::calculateTotal()`.
   - Система перенаправляет квартиросъёмщика на страницу оплаты с помощью метода `Payment::redirect()`.

3. **Обработка платежа:**
   - Система получает сведения о платеже и предосталяет пользователю оплатить с использованием банковской карты.
   - После успешной оплаты система вызывает метод `Payment::complete()` для подтверждения успешного завершения транзакции.

4. **Генерация договора аренды:**
   - Система генерирует электронный договор аренды с юридически значимыми данными и вызывает метод `RentalAgreement::generate()`.
   - Система передаёт данные о договоре в метод `LegalRegistry::register()` для регистрации в системе юридической регистрации.

5. **Уведомление участников:**
   - После успешного заключения договора система уведомляет квартиросъёмщика и владельца через методы `notifyUser(tenant_id, message)` и `notifyUser(owner_id, message)` о том, что аренда подтверждена и оплата прошла успешно.

**Варианты альтернативных решений:**

   *2.1 Квартиросъёмщик выбирает рассрочку или частичную оплату:
      1. **Квартиросъёмщик** выбирает опцию рассрочки.
      2. **Система** вызывает метод `Payment::createInstallmentPlan()`, который разбивает сумму на несколько платежей.
      3. **Квартиросъёмщик** подтверждает первый платёж, а система заключает договор с отсрочкой полной оплаты.

   *4.1 Квартиросъёмщик запрашивает изменение условий аренды:
      1. **Квартиросъёмщик** выбирает опцию изменения условий перед оплатой.
      2. **Система** перенаправляет пользователя в чат с владельцем для обсуждения новых условий аренды.
      3. **После согласования** система обновляет данные договора через метод `RentalAgreement::updateTerms()`.

   *5.1 Платеж не прошёл успешно:
      1. **Система** получает уведомление об ошибке через `Payment::fail()`.
      2. **Квартиросъёмщик** получает уведомление о неудачной попытке оплаты с предложением попробовать другой способ.

   *5.2 Связь с платёжной системой потеряна:
      1. **Система** уведомляет квартиросъёмщика о технической проблеме.
      2. **Квартиросъёмщик** может попробовать оплатить позже.

Расширения (или альтернативные потоки) 

*а. Каждый раз при попытке менеджера отменить операцию выполняются следующие дей­ствия.

    1.	Система переходит в режим обслуживания менеджера.

    2.	Менеджер или кассир выполняют одну операцию в режиме обслуживания менеджера, т.е. изменяют баланс, завершают продажу и т.п.

    3.	Система возвращается в режим обслуживания кассира.

*б. При каждом выходе системы из строя.

    Для ввода системы в строй и корректной обработки платежа нужно обеспечить восстанов­ление всех транзакций и событий с любого шага сценария. 
    1.	Кассир перезапускает систему, регистрируется и предлагает восстановить предыдущее состояние.
    2.	 Система восстанавливает предыдущее состояние.
        2а. Система определяет аномалию, повлекшую сбой.
            1.	Система уведомляет об ошибке кассира, регистрирует ошибку и переходит в на­чальное состояние.
            2.	Кассир начинает новую продажу.

1а. Покупатель или менеджер хотят досрочно прервать продажу.

    1. Кассир завершает операцию.
    2.	Система отображает состояние завершенной операции с общей стоимостью покупки.
        2а. Информация о продаже не найдена.
            1.	Система сигнализирует об ошибке кассира.
            2.	Кассир начинает новую операцию продажи и вводит все необходимые элементы.
    3.	Кассир продолжает обслуживание клиента (вводит новые товары и обрабатывает платеж).

2а. Покупатель сообщает кассиру о льготах.

    1.	Кассир проверяет наличие льгот и вводит шифр льготного покупателя.
    2.	Система записывает статус покупателя, который будет использоваться при начислении налоговых платежей.


 **Специальные требования:**

- Процесс оплаты и заключения договора должен быть интуитивно понятным для всех пользователей.
- Система должна обеспечивать безопасность платежных и персональных данных (SSL/TLS).
- Время обработки договора и регистрации не должно превышать 5 минут.
- Платформа должна поддерживать различные платёжные методы (банковские карты, электронные кошельки и т.д.).

 **Список технологий и типов данных:**

- Платёжные данные защищены с использованием SSL/TLS.
- Юридическая регистрация осуществляется через интеграцию с внешними системами на основе API.

 **Частота использования:**

- Ожидается средняя частота использования, особенно во время активных периодов поиска жилья (сезон отпусков, учебные периоды).

 **Открытые вопросы:**

- Нужно ли добавлять возможность заморозки оплаты до полного подписания договора?
- Какие способы оплаты наиболее предпочтительны для российских пользователей?
- Как решать вопросы с возвратом средств в случае нарушения условий аренды?
